generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum IntakeTone {
  basic
  family
  legal
  critical
}

enum IntakePriority {
  low
  medium
  high
  critical
}

enum IntakeStatus {
  pending
  accepted
  rejected
}

model ContactIntake {
  id        String         @id @default(uuid())
  createdAt DateTime       @default(now())
  tone      IntakeTone
  route     String
  priority  IntakePriority
  name      String?
  email     String
  message   String
  phone     String?
  status    IntakeStatus   @default(pending)
  spamScore Float?
  meta      Json?

  consentAcceptances     ConsentAcceptance[]
  slaTimers              SlaTimer[]
  derivationConsents     DerivationConsent[]
  transferPackets        TransferPacket[]
  legalHolds             LegalHold[]
  deletionLogs           DeletionLog[]

  // Performance indexes
  @@index([status])
  @@index([priority])
  @@index([createdAt(sort: Desc)])
  @@index([status, priority])
  @@index([email])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  intakeId   String?
  metadata   Json?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([intakeId])
  @@index([occurredAt(sort: Desc)])
}

model SlaTimer {
  id          String    @id @default(uuid())
  intakeId    String
  milestone   String
  deadlineAt  DateTime
  completedAt DateTime?
  status      String    @default("pending")
  createdAt   DateTime  @default(now())

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@unique([intakeId, milestone])
  @@index([status])
  @@index([deadlineAt])
  @@index([intakeId])
}

model ConsentVersion {
  id             String   @id @default(uuid())
  version        String   @unique
  content        String
  checksumSha256 String
  createdAt      DateTime @default(now())
  isActive       Boolean  @default(false)

  acceptances ConsentAcceptance[]
}

model ConsentAcceptance {
  id               String   @id @default(uuid())
  consentVersionId String
  intakeId         String
  acceptedAt       DateTime @default(now())
  ipHash           String?
  userAgent        String?
  locale           String?

  consentVersion ConsentVersion @relation(fields: [consentVersionId], references: [id])
  intake         ContactIntake  @relation(fields: [intakeId], references: [id])

  @@index([consentVersionId])
  @@index([intakeId])
}

// ── Legal Derivation ──────────────────────────────────────────

model DerivationConsent {
  id              String    @id @default(uuid())
  intakeId        String
  recipientEntity String
  consentedAt     DateTime  @default(now())
  revokedAt       DateTime?
  ipHash          String?
  userAgent       String?

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@index([intakeId])
  @@index([recipientEntity])
}

model TransferPacket {
  id               String    @id @default(uuid())
  intakeId         String
  recipientEntity  String
  manifestHash     String
  payloadSizeBytes Int
  legalBasis       String
  transferredAt    DateTime  @default(now())
  acknowledgedAt   DateTime?

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@index([intakeId])
  @@index([manifestHash])
  @@index([transferredAt(sort: Desc)])
}

// ── Retention & Legal Hold ────────────────────────────────────

model LegalHold {
  id        String    @id @default(uuid())
  intakeId  String
  reason    String
  placedBy  String
  createdAt DateTime  @default(now())
  liftedAt  DateTime?

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@index([intakeId])
  @@index([liftedAt])
}

model DeletionLog {
  id        String   @id @default(uuid())
  intakeId  String
  reason    String
  trigger   String
  deletedAt DateTime @default(now())

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@index([intakeId])
  @@index([deletedAt(sort: Desc)])
  @@index([trigger])
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum IntakeTone {
  basic
  family
  legal
  critical
}

enum IntakePriority {
  low
  medium
  high
  critical
}

enum IntakeStatus {
  pending
  accepted
  rejected
}

model ContactIntake {
  id        String         @id @default(uuid())
  createdAt DateTime       @default(now())
  tone      IntakeTone
  route     String
  priority  IntakePriority
  name      String?
  email     String
  message   String
  phone     String?
  status    IntakeStatus   @default(pending)
  spamScore Float?
  meta      Json?

  consentAcceptances ConsentAcceptance[]
  slaTimers          SlaTimer[]

  // Performance indexes
  @@index([status])
  @@index([priority])
  @@index([createdAt(sort: Desc)])
  @@index([status, priority])
  @@index([email])
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String
  intakeId   String?
  metadata   Json?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([intakeId])
  @@index([occurredAt(sort: Desc)])
}

model SlaTimer {
  id          String    @id @default(uuid())
  intakeId    String
  milestone   String
  deadlineAt  DateTime
  completedAt DateTime?
  status      String    @default("pending")
  createdAt   DateTime  @default(now())

  intake ContactIntake @relation(fields: [intakeId], references: [id])

  @@unique([intakeId, milestone])
  @@index([status])
  @@index([deadlineAt])
  @@index([intakeId])
}

model ConsentVersion {
  id             String   @id @default(uuid())
  version        String   @unique
  content        String
  checksumSha256 String
  createdAt      DateTime @default(now())
  isActive       Boolean  @default(false)

  acceptances ConsentAcceptance[]
}

model ConsentAcceptance {
  id               String   @id @default(uuid())
  consentVersionId String
  intakeId         String
  acceptedAt       DateTime @default(now())
  ipHash           String?
  userAgent        String?
  locale           String?

  consentVersion ConsentVersion @relation(fields: [consentVersionId], references: [id])
  intake         ContactIntake  @relation(fields: [intakeId], references: [id])

  @@index([consentVersionId])
  @@index([intakeId])
}
